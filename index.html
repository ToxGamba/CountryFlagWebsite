<div id="country-list"></div>
<input type="text" id="search" placeholder="Search for a country..." />
<button id="random-btn">Show Random Fact</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, onValue, update, push } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC8X4vku5TqaD_toaNNbBaX46yxHjCYSd8",
    authDomain: "countryflagwebsite.firebaseapp.com",
    databaseURL: "https://countryflagwebsite-default-rtdb.firebaseio.com",
    projectId: "countryflagwebsite",
    storageBucket: "countryflagwebsite.firebasestorage.app",
    messagingSenderId: "1019419410071",
    appId: "1:1019419410071:web:9362a50598211638caf3d2"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const countryListDiv = document.getElementById("country-list");
  const searchInput = document.getElementById("search");
  const randomBtn = document.getElementById("random-btn");

  // Load countries from Firebase
  function loadCountries() {
    const countriesRef = ref(db, 'facts');
    onValue(countriesRef, (snapshot) => {
      const data = snapshot.val();
      countryListDiv.innerHTML = "";
      for (const key in data) {
        const country = data[key].country;
        const fact = data[key].fact;
        const likes = data[key].likes || 0;

        fetch(`https://restcountries.com/v3.1/name/${country}?fullText=true`)
          .then(res => res.json())
          .then(countryData => {
            const flagURL = countryData[0].flags.png;
            const div = document.createElement("div");
            div.className = "country";
            div.innerHTML = `
              <img src="${flagURL}" alt="${country} Flag" class="flag">
              <h2>${country}</h2>
              <p>${fact}</p>
              <button class="like-btn" data-key="${key}">üëç Like (<span class="like-count">${likes}</span>)</button>
            `;
            countryListDiv.appendChild(div);

            // Like button
            div.querySelector(".like-btn").addEventListener("click", () => {
              const likeRef = ref(db, `facts/${key}/likes`);
              update(likeRef, { ".value": likes + 1 }); // update likes
            });
          })
          .catch(err => console.log("Flag error:", err));
      }
    });
  }

  // Search filter
  searchInput.addEventListener("keyup", () => {
    const countryDivs = document.getElementsByClassName("country");
    const filter = searchInput.value.toLowerCase();
    let matches = 0;
    for (let div of countryDivs) {
      const name = div.getElementsByTagName("h2")[0].innerText.toLowerCase();
      if (name.includes(filter)) { div.style.display = ""; matches++; }
      else div.style.display = "none";
    }
  });

  // Random fact
  randomBtn.addEventListener("click", () => {
    const visible = Array.from(document.getElementsByClassName("country")).filter(c => c.style.display !== "none");
    if (!visible.length) return;
    visible.forEach(c => c.style.display = "none");
    const random = visible[Math.floor(Math.random() * visible.length)];
    random.style.display = "";
  });

  loadCountries();
</script>
